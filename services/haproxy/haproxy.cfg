global
    log /dev/log local0
    log /dev/log local1 notice
    # chroot /var/lib/haproxy
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 5s
    timeout client 30s
    timeout server 30s

# --- HTTP Frontend ---
frontend http_frontend
    bind *:80
    mode tcp

    # ACLs for HTTP domains (via Host header)
    acl hl_domain_http hdr(host) -m end .hl.kuipr.de
    acl k8s_domain_http hdr(host) -m end .k8s.kuipr.de

    use_backend hl_backend_http if hl_domain_http
    use_backend k8s_backend_http if k8s_domain_http

    # Default to Anubis fallback for all other HTTP traffic
    default_backend http_backend

# --- HTTPS Frontend ---
frontend https_frontend
    bind *:443
    mode tcp

    # Delay content inspection for TLS SNI routing
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 }

    # ACLs for HTTPS domains (via SNI)
    acl hl_domain req.ssl_sni -m end .hl.kuipr.de
    acl k8s_domain req.ssl_sni -m end .k8s.kuipr.de

    use_backend hl_backend_https if hl_domain
    use_backend k8s_backend_https if k8s_domain

    # Default to Anubis fallback for all other HTTPS traffic
    default_backend traefik_backend_https

# --- HTTP Backends (Anubis) ---
backend hl_backend_http
    mode tcp
    server anubis_hl 127.0.0.1:8924

backend k8s_backend_http
    mode tcp
    server anubis_k8s 127.0.0.1:8925

backend http_backend
    # Default HTTP backend (Traefik via Anubis)
    mode tcp
    server anubis_default 127.0.0.1:8923

# --- HTTPS Backends (Anubis) ---
backend hl_backend_https
    mode tcp
    server anubis_hl 127.0.0.1:8924

backend k8s_backend_https
    mode tcp
    server anubis_k8s 127.0.0.1:8925

backend traefik_backend_https
    # Default HTTPS backend (Traefik via Anubis)
    mode tcp
    server anubis_default 127.0.0.1:8923
